üéØ Objective

Implement anti-thrash TV lock logic so TVs do not rapidly switch between games.
This must work alongside existing manual TV locks (up to 2 hours) and only affect automatic assignment behavior.

üß© Step 1: Distinguish Manual vs Automatic Locks

Ensure each TV assignment has:

{
  tvId: string
  gameId: string
  assignedAt: number
  manualLockUntil?: number
}


Rules:

If manualLockUntil exists and is in the future ‚Üí do not allow any automatic switches

Anti-thrash logic applies only when no manual lock is active

üß± Step 2: Add Automatic Lock Metadata

Add automatic assignment metadata:

{
  autoLockUntil: number
}


Set autoLockUntil when:

A TV is auto-assigned or auto-switched

Default:

autoLockUntil = assignedAt + 8 minutes

‚õî Step 3: Endgame Protection (No Switch Allowed)

Define protected game states:

Football (NFL / NCAAF)

Final 5 minutes

Overtime

Basketball (NBA / NCAAM / NCAAW)

Final 2 minutes

Overtime

Hockey (NHL)

Final 5 minutes

Overtime

Baseball (MLB)

8th inning or later

Walk-off situations

Create:

game.isProtectedEndgame = boolean


If currentGame.isProtectedEndgame === true:
‚Üí Disallow automatic switching entirely

üî• Step 4: Hotness Delta Threshold

Define:

HOTNESS_DELTA_THRESHOLD = 15


Allow an automatic switch only if:

challenger.hotness >= current.hotness + HOTNESS_DELTA_THRESHOLD


If not, keep the current game.

‚è±Ô∏è Step 5: Automatic Lock Duration Enforcement

If:

now < autoLockUntil


Then:
‚Üí Disallow automatic switching, unless:

Challenger hotness ‚â• 90

OR challenger is in protected endgame and current game is not

üîÑ Step 6: Decision Flow (Authoritative)

Implement automatic switching logic in this order:

If manual lock active ‚Üí KEEP

If current game is protected endgame ‚Üí KEEP

If auto lock active ‚Üí KEEP

If challenger hotness < current hotness + delta ‚Üí KEEP

Otherwise ‚Üí SWITCH

This order is critical.

üß† Step 7: Explainability (Optional but Recommended)

Attach reasons when a switch is prevented:

switchDecisionReason:
- "Manual lock active"
- "Endgame protection"
- "Auto-lock active"
- "Hotness delta not met"


Helpful for debugging and UI transparency.

üß™ Step 8: Logging & Validation

Add logs:

[AutoAssign] TV=3 KEEP (Endgame protection)
[AutoAssign] TV=5 KEEP (Auto-lock active)
[AutoAssign] TV=2 SWITCH (Hotness +22)

üö´ Constraints

Do not alter manual lock behavior

Do not reduce max manual lock duration

Automatic logic must never override manual locks

Fail safely (KEEP) if any data is missing